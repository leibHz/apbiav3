{% extends "base.html" %}

{% block title %}Relatório de {{ orientado.nome_completo }} - APBIA{% endblock %}

{% block content %}
<div class="relatorio-container">
    <!-- Header -->
    <div class="relatorio-header">
        <div>
            <h2>
                <i class="fas fa-chart-bar"></i> Relatório de Acompanhamento
            </h2>
            <p>{{ orientado.nome_completo }}</p>
        </div>
        <div style="display: flex; gap: 1rem;">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i> Imprimir
            </button>
            <button onclick="exportarPDF()" class="btn btn-danger">
                <i class="fas fa-file-pdf"></i> Exportar PDF
            </button>
            <a href="{{ url_for('orientador.visualizar_orientado', participante_id=orientado.id) }}" 
               class="btn btn-secondary no-print">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>
    
    <!-- Dados do Orientado -->
    <div class="relatorio-secao">
        <h3><i class="fas fa-user"></i> Dados do Orientado</h3>
        <div class="dados-grid">
            <div class="dado-item">
                <strong>Nome Completo:</strong>
                <span>{{ orientado.nome_completo }}</span>
            </div>
            <div class="dado-item">
                <strong>Email:</strong>
                <span>{{ orientado.email }}</span>
            </div>
            <div class="dado-item">
                <strong>BP:</strong>
                <span><code>{{ orientado.numero_inscricao }}</code></span>
            </div>
            <div class="dado-item">
                <strong>Data de Cadastro:</strong>
                <span>{{ orientado.data_criacao.strftime('%d/%m/%Y') if orientado.data_criacao else '-' }}</span>
            </div>
        </div>
    </div>
    
    <!-- Estatísticas de Uso -->
    <div class="relatorio-secao">
        <h3><i class="fas fa-chart-line"></i> Estatísticas de Uso da IA</h3>
        <div class="stats-grid-relatorio">
            <div class="stat-box">
                <i class="fas fa-comments"></i>
                <h4>{{ stats.total_conversas }}</h4>
                <small>Conversas com IA</small>
            </div>
            <div class="stat-box">
                <i class="fas fa-paper-plane"></i>
                <h4>{{ stats.total_mensagens }}</h4>
                <small>Mensagens Enviadas</small>
            </div>
            <div class="stat-box">
                <i class="fas fa-flask"></i>
                <h4>{{ stats.total_projetos }}</h4>
                <small>Projetos Criados</small>
            </div>
            <div class="stat-box">
                <i class="fas fa-search"></i>
                <h4>{{ stats.uso_google_search }}</h4>
                <small>Uso de Google Search</small>
            </div>
            <div class="stat-box">
                <i class="fas fa-book"></i>
                <h4>{{ stats.uso_modo_bragantec }}</h4>
                <small>Uso do Modo Bragantec</small>
            </div>
            <div class="stat-box">
                <i class="fas fa-sticky-note"></i>
                <h4>{{ stats.total_notas_orientador }}</h4>
                <small>Notas Adicionadas</small>
            </div>
        </div>
    </div>
    
    <!-- Projetos -->
    <div class="relatorio-secao">
        <h3><i class="fas fa-flask"></i> Projetos ({{ projetos|length }})</h3>
        {% if projetos %}
        <div class="projetos-lista-relatorio">
            {% for projeto in projetos %}
            <div class="projeto-relatorio-item">
                <div class="projeto-relatorio-header">
                    <h5>{{ projeto.nome }}</h5>
                    <div class="projeto-badges-relatorio">
                        <span class="badge-relatorio categoria">{{ projeto.categoria }}</span>
                        <span class="badge-relatorio status">{{ projeto.status|replace('_', ' ')|title }}</span>
                        {% if projeto.gerado_por_ia %}
                        <span class="badge-relatorio ia">
                            <i class="fas fa-robot"></i> Gerado por IA
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                {% if projeto.resumo %}
                <p class="projeto-resumo-relatorio">
                    <strong>Resumo:</strong> {{ projeto.resumo }}
                </p>
                {% endif %}
                
                {% if projeto.palavras_chave %}
                <p class="projeto-palavras-relatorio">
                    <strong>Palavras-chave:</strong> {{ projeto.palavras_chave }}
                </p>
                {% endif %}
                
                <p class="projeto-data-relatorio">
                    <i class="far fa-calendar"></i> 
                    Criado em: {{ projeto.data_criacao.strftime('%d/%m/%Y') if projeto.data_criacao else '-' }}
                </p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="texto-vazio">Nenhum projeto criado até o momento.</p>
        {% endif %}
    </div>
    
    <!-- Conversas -->
    <div class="relatorio-secao">
        <h3><i class="fas fa-comments"></i> Histórico de Conversas ({{ chats|length }})</h3>
        {% if chats %}
        <div class="chats-lista-relatorio">
            {% for chat in chats %}
            <div class="chat-relatorio-item">
                <div class="chat-relatorio-header">
                    <h6>{{ chat.titulo }}</h6>
                    <small>{{ chat.data_criacao.strftime('%d/%m/%Y %H:%M') if chat.data_criacao else '' }}</small>
                </div>
                <a href="{{ url_for('orientador.visualizar_chat', chat_id=chat.id) }}" 
                   class="btn-visualizar-chat no-print">
                    <i class="fas fa-eye"></i> Visualizar Conversa Completa
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="texto-vazio">Nenhuma conversa registrada.</p>
        {% endif %}
    </div>
    
    <!-- Observações do Orientador -->
    <div class="relatorio-secao">
        <h3><i class="fas fa-clipboard"></i> Observações do Orientador</h3>
        <div class="observacoes-box">
            <textarea id="observacoesOrientador" 
                      class="observacoes-textarea no-print"
                      placeholder="Adicione suas observações sobre o orientado aqui...">{{ observacoes or '' }}</textarea>
            <div class="observacoes-print" style="display: none;">
                {{ observacoes or 'Nenhuma observação registrada.' }}
            </div>
            <button onclick="salvarObservacoes()" class="btn btn-primary no-print" style="margin-top: 1rem;">
                <i class="fas fa-save"></i> Salvar Observações
            </button>
        </div>
    </div>
    
    <!-- Rodapé -->
    <div class="relatorio-rodape">
        <p>
            <strong>Relatório gerado em:</strong> {{ data_geracao.strftime('%d/%m/%Y às %H:%M') }}
            <br>
            <strong>Orientador:</strong> {{ current_user.nome_completo }}
        </p>
    </div>
</div>

<script>
function exportarPDF() {
    APBIA.showNotification('Preparando para impressão...', 'info');
    setTimeout(() => {
        window.print();
    }, 500);
}

async function salvarObservacoes() {
    const observacoes = document.getElementById('observacoesOrientador').value;
    
    APBIA.showLoadingOverlay('Salvando observações...');
    
    try {
        const response = await fetch('/orientador/salvar-observacoes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                participante_id: {{ orientado.id }},
                observacoes: observacoes
            })
        });
        
        const data = await response.json();
        
        APBIA.hideLoadingOverlay();
        
        if (data.success) {
            APBIA.showNotification('Observações salvas!', 'success');
        } else {
            APBIA.showNotification('Erro: ' + data.message, 'error');
        }
    } catch (error) {
        APBIA.hideLoadingOverlay();
        APBIA.showNotification('Erro ao salvar', 'error');
    }
}
</script>

<style>
.relatorio-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    background: var(--bg-card);
    border-radius: 12px;
}

.relatorio-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.relatorio-secao {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--bg-darker);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.relatorio-secao h3 {
    margin-bottom: 1rem;
    color: var(--text-primary);
    border-bottom: 2px solid var(--primary);
    padding-bottom: 0.5rem;
}

.dados-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.dado-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.dado-item strong {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.dado-item span {
    color: var(--text-primary);
    font-size: 1rem;
}

.stats-grid-relatorio {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
}

.stat-box {
    background: var(--bg-card);
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
    border: 1px solid var(--border-color);
}

.stat-box i {
    font-size: 2rem;
    color: var(--primary);
    display: block;
    margin-bottom: 0.5rem;
}

.stat-box h4 {
    font-size: 2rem;
    margin: 0.5rem 0;
    color: var(--text-primary);
}

.stat-box small {
    color: var(--text-secondary);
}

.projetos-lista-relatorio,
.chats-lista-relatorio {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.projeto-relatorio-item,
.chat-relatorio-item {
    background: var(--bg-card);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.projeto-relatorio-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.projeto-badges-relatorio {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.badge-relatorio {
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
}

.badge-relatorio.categoria {
    background: var(--primary);
    color: #FFF;
}

.badge-relatorio.status {
    background: var(--success);
    color: #000;
}

.badge-relatorio.ia {
    background: var(--info);
    color: #FFF;
}

.observacoes-box {
    background: var(--bg-card);
    padding: 1rem;
    border-radius: 8px;
}

.observacoes-textarea {
    width: 100%;
    min-height: 200px;
    padding: 1rem;
    background: var(--bg-darker);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    resize: vertical;
}

.relatorio-rodape {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 2px solid var(--border-color);
    text-align: center;
    color: var(--text-secondary);
}

.texto-vazio {
    text-align: center;
    color: var(--text-muted);
    padding: 2rem;
}

/* Estilos para impressão */
@media print {
    .no-print {
        display: none !important;
    }
    
    .observacoes-textarea {
        display: none;
    }
    
    .observacoes-print {
        display: block !important;
        padding: 1rem;
        white-space: pre-wrap;
    }
    
    .relatorio-container {
        background: white;
        color: black;
    }
    
    .relatorio-secao {
        page-break-inside: avoid;
    }
}
</style>
{% endblock %}