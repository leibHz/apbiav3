{% extends "base.html" %}

{% block title %}Gerenciar Participantes dos Projetos - APBIA{% endblock %}

{% block content %}
<div class="usuarios-container">
    <div class="usuarios-header">
        <div class="usuarios-header-info">
            <h2>
                <i class="fas fa-users-cog"></i> Gerenciar Participantes dos Projetos
            </h2>
            <p>Associe participantes aos seus respectivos projetos</p>
        </div>
        <button class="btn btn-salvar" onclick="openModal('addParticipanteModal')">
            <i class="fas fa-plus"></i> Adicionar Participante a Projeto
        </button>
    </div>
    
    <!-- Lista de Projetos com Participantes -->
    <div class="projetos-participantes-grid">
        {% for item in projetos_com_participantes %}
        <div class="projeto-card">
            <div class="projeto-card-header">
                <div>
                    <h5>
                        <i class="fas fa-flask"></i> {{ item.projeto.nome }}
                    </h5>
                    <span class="badge success">{{ item.projeto.categoria }}</span>
                    <span class="badge secondary">{{ item.projeto.status }}</span>
                </div>
            </div>
            <div class="projeto-card-body">
                <h6 style="color: var(--text-primary); margin-bottom: 1rem;">
                    <i class="fas fa-user-graduate"></i> Participantes ({{ item.participantes|length }})
                </h6>
                
                {% if item.participantes %}
                <div class="participantes-list">
                    {% for participante in item.participantes %}
                    <div class="participante-item">
                        <div>
                            <strong>{{ participante.nome_completo }}</strong>
                            <br>
                            <small style="color: var(--text-muted);">
                                {{ participante.email }} | BP: {{ participante.numero_inscricao }}
                            </small>
                        </div>
                        <button class="btn-action delete remover-participante"
                                data-projeto-id="{{ item.projeto.id }}"
                                data-participante-id="{{ participante.id }}"
                                title="Remover participante">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state-small">
                    <i class="fas fa-user-slash"></i>
                    <p>Nenhum participante neste projeto</p>
                </div>
                {% endif %}
                
                <button class="btn btn-primary btn-sm" 
                        style="margin-top: 1rem; width: 100%;"
                        onclick="abrirModalAdicionar({{ item.projeto.id }}, '{{ item.projeto.nome }}')">
                    <i class="fas fa-user-plus"></i> Adicionar Participante
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal: Adicionar Participante -->
<div class="modal-overlay" id="addParticipanteModal">
    <div class="modal">
        <div class="modal-header">
            <h5>
                <i class="fas fa-user-plus"></i> Adicionar Participante ao Projeto
            </h5>
            <button class="modal-close" onclick="closeModal('addParticipanteModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="formAddParticipante">
                <div class="form-group">
                    <label class="form-label">Projeto *</label>
                    <select class="form-select" id="projetoSelect" required>
                        <option value="">Selecione um projeto...</option>
                        {% for projeto in projetos %}
                        <option value="{{ projeto.id }}">
                            [{{ projeto.categoria }}] {{ projeto.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Participante *</label>
                    <select class="form-select" id="participanteSelect" required>
                        <option value="">Selecione um participante...</option>
                        {% for participante in participantes %}
                        <option value="{{ participante.id }}">
                            {{ participante.nome_completo }} ({{ participante.numero_inscricao }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancelar" onclick="closeModal('addParticipanteModal')">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn btn-salvar" onclick="adicionarParticipante()">
                <i class="fas fa-check"></i> Adicionar
            </button>
        </div>
    </div>
</div>

<script>
function openModal(id) {
    document.getElementById(id).classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
    document.getElementById('formAddParticipante').reset();
}

function abrirModalAdicionar(projetoId, projetoNome) {
    document.getElementById('projetoSelect').value = projetoId;
    openModal('addParticipanteModal');
}

async function adicionarParticipante() {
    const projetoId = document.getElementById('projetoSelect').value;
    const participanteId = document.getElementById('participanteSelect').value;
    
    if (!projetoId || !participanteId) {
        APBIA.showNotification('Selecione projeto e participante', 'error');
        return;
    }
    
    APBIA.showLoadingOverlay('Adicionando participante...');
    
    try {
        const response = await fetch('/admin/adicionar-participante-projeto', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                projeto_id: parseInt(projetoId),
                participante_id: parseInt(participanteId)
            })
        });
        
        const data = await response.json();
        
        APBIA.hideLoadingOverlay();
        
        if (data.success) {
            APBIA.showNotification(data.message, 'success');
            closeModal('addParticipanteModal');
            setTimeout(() => location.reload(), 1000);
        } else {
            APBIA.showNotification('Erro: ' + data.message, 'error');
        }
    } catch (error) {
        APBIA.hideLoadingOverlay();
        APBIA.showNotification('Erro ao adicionar participante', 'error');
        console.error(error);
    }
}

// Remover participante
document.querySelectorAll('.remover-participante').forEach(btn => {
    btn.addEventListener('click', async function() {
        if (!confirm('Remover este participante do projeto?')) return;
        
        const projetoId = this.dataset.projetoId;
        const participanteId = this.dataset.participanteId;
        
        APBIA.showLoadingOverlay('Removendo...');
        
        try {
            const response = await fetch('/admin/remover-participante-projeto', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    projeto_id: parseInt(projetoId),
                    participante_id: parseInt(participanteId)
                })
            });
            
            const data = await response.json();
            
            APBIA.hideLoadingOverlay();
            
            if (data.success) {
                APBIA.showNotification(data.message, 'success');
                this.closest('.participante-item').remove();
            } else {
                APBIA.showNotification('Erro: ' + data.message, 'error');
            }
        } catch (error) {
            APBIA.hideLoadingOverlay();
            APBIA.showNotification('Erro ao remover participante', 'error');
        }
    });
});
</script>

<style>
.projetos-participantes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.projeto-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

.projeto-card-header {
    background: var(--bg-darker);
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.projeto-card-header h5 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
}

.projeto-card-body {
    padding: 1rem;
}

.participantes-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.participante-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: var(--bg-darker);
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.empty-state-small {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
}

.empty-state-small i {
    font-size: 2rem;
    display: block;
    margin-bottom: 0.5rem;
    opacity: 0.3;
}
</style>
{% endblock %}